kind: Deployment
replicaCount: 1

rbac:
  create: false
image:
  repository: {{ image_repository }}
  pullPolicy: Always
  tag: {{ image_tag }}

extraVolumes:
  - name: gcs-credentials
    secret:
      secretName: google-service-account-sa-key

extraVolumeMounts:
  - name: gcs-credentials
    mountPath: /google_service_credentials.json
    subPath: google_service_credentials.json

config:
  service: |
    [SERVICE]
        Flush      1
        Daemon     off
        Log_Level  info
        HTTP_Server  On
        HTTP_Listen  0.0.0.0
        HTTP_PORT    2020
        storage.sync               normal
        storage.checksum           on
        storage.backlog.mem_limit  50M
        storage.metrics            on
        storage.max_chunks_up      128
  inputs: |
    [INPUT]
        Name               tail
        Tag                {{ logid }}
        Path               /var/log/messages,/var/log/syslog
        DB                 /tmp/default_pipeline_syslog
        Read_from_Head     True
        Buffer_Chunk_Size  512k
        Buffer_Max_Size    5M
        Key                message
        Rotate_Wait        30
        Skip_Long_Lines    On
        storage.type       filesystem
        Mem_Buf_Limit      10M

  filters: |
    [FILTER]
        Name  modify
        Match {{ logid }}
        Add   logName syslog
    [FILTER]
        Name                  rewrite_tag
        Match                 {{ logid }}
        Rule                  $logName .* $logName false
        Emitter_Storage.type  filesystem
        Emitter_Mem_Buf_Limit 10M
    [FILTER]
        Name   modify
        Match  syslog
        Remove logName
  outputs: |
    [OUTPUT]
        Name              stackdriver
        Match_Regex       ^(syslog)$
        resource          gce_instance
        stackdriver_agent Google-Cloud-Ops-Agent-Logging/latest (BuildDistro=build_distro;Platform=linux;ShortName=linux_platform;ShortVersion=linux_platform_version)
        workers           8
        Retry_Limit  3
        tls         On
        tls.verify  Off
        google_service_credentials /google_service_credentials.json